<?php namespace ProcessWire;

use RRule\RRule;

/**
 * FieldtypeEvents: InputfieldEvent
 *
 * Collects input for FieldtypeEvents fields. This accompanies the FieldtypeEvents as a demonstration
 * of creating a multi-value Fieldtype and Inputfield.
 *
 */
class InputfieldRecurringDates extends Inputfield
{
    const defaultRows = 5;
    private static $alpine_added = false;
    public function __construct()
    {
        parent::__construct();
        //$this->setAttribute('type', 'textarea');
        //$this->setAttribute('rows', self::defaultRows);
    }

    public function init()
    {
        /*$this->addHookAfter('AdminThemeUikit::renderFile', function ($e) {
            bd($e->arguments(0));
        });*/
        //if(!self::$alpine_added) {
        /*$this->addHookAfter('AdminTheme::getExtraMarkup', function ($e) {
            $parts = $e->return;
            $parts['head'] .= "<script defer src='https://unpkg.com/alpinejs@3.10.2/dist/cdn.min.js'></script>";
            //$parts['head'] .= '<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.5/dayjs.min.js"></script>';
            //$parts['head'] .= '<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.5/plugin/utc.js"></script>';
            //$parts['head'] .= '<script>dayjs.extend(window.dayjs_plugin_utc)</script>';
            InputfieldRecurringDates::$alpine_added = true;
            $e->return = $parts;
        });*/
        //}
        //$alpineSource = "";
        //$this->config->scripts->add($alpineSource);
    }

    public function renderReady(Inputfield $parent = null, $renderValueMode = false){
        $this->config->scripts->add("https://unpkg.com/alpinejs@3.10.2/dist/cdn.min.js");
        parent::renderReady($parent, $renderValueMode);
    }

    public static function getModuleInfo()
    {
        return array(
          'title'    => 'InputfieldRecurringDates',
          'version'  => 001,
          'summary'  => 'Input field for recurring dates.',
          'icon'     => 'calendar-o',
          'requires' => 'FieldtypeRecurringDates',
        );
    }
    /*
        public function renderReady(Inputfield $parent = null, $renderValueMode = false)
        {
            $config = $this->config;
            if(!$config->js("InputfieldRepeatingDates_{$this->name}")) {
                $config->js("InputfieldRepeatingDates_{$this->name}", [
                  '' => ""
                ]);
            }
        return parent::renderReady($parent, $renderValueMode); // TODO: Change the autogenerated stub
    }
    */

    public function ___render()
    {
        /** @var RecurringDate $recurring_dates */
        $recurring_dates = $this->value;
        $this->setAttribute('class', $this->getAttribute('class') . ' main-input uk-width-1-1');
        // $saved_rrule = $this->hasPage()->meta()->get($this->name);
        bd($this->value);
        // $parsed_json = json_decode($this->value->rrule, true);
        // $parsed_rule = new RRule($parsed_json);
        $occurrences = $recurring_dates->occurrences;
        //bd($occurrences);
        //bd($recurring_dates->rrule);
        //bd($dates);
        //$this->setAttribute('type', 'hidden');
        $this->setAttribute('class', 'uk-input main-input');
        $this->setAttribute('value', [$this->value->rrule]);
        $this->setAttribute('x-ref', 'main-input');
        $this->setAttribute('x-model', '_rrule');
        $this->setAttribute('data-rrule', $recurring_dates->rrule);
        $this->setAttribute('data-settings', $recurring_dates->settings);

        $out = "";
        $filePath = "{$this->config->paths->siteModules}FieldtypeRecurringDates/partials/AlpineComponent.php";
        $alpineComponent = wireRenderFile($filePath, [
          'fieldtype'  => $this->hasFieldtype,
          'inputfield' => $this,
          'occurrences'      => $occurrences
        ]);

        $out .= $alpineComponent;
        return $out;
    }


    public function ___renderValue()
    {
        $fieldtype = $this->hasFieldtype;
        return $fieldtype->markupValue($this->hasPage, $this->hasField, $this->value);
    }


    public function ___processInput(WireInputData $input)
    {
        $name = $this->attr('name');
        $recurring_date_obj = new RecurringDate();
        // bd($recurring_date_obj);
        // $dates = new OccurrenceArray();
        $value = $input[$name];
        $settings = $input[$name . "_settings"];

        if($value === "") return $recurring_date_obj;

        /*foreach(json_decode($settings, true) as $key => $setting){
            $recurring_date_obj->settings->set($key, $setting);
        }*/
        $recurring_date_obj->settings = $settings;
        // bd($recurring_date_obj->settings);

        //$page = $this->hasPage;
        $recurring_date_obj->rrule = $value;


        $value = json_decode($value, true);

        $rrule = new RRule($value);

        foreach ($rrule as $date) {
            $occurrence_date = new Occurrence();
            $occurrence_date->excluded = false;
            $occurrence_date->date = $date;
            $recurring_date_obj->occurrences->add($occurrence_date);
            //$dates->add($ocurrence_date);
        }

        bd($recurring_date_obj->settings);

        //$page->meta()->set($name, $value);
        $this->val($recurring_date_obj);
        $this->trackChange('value');

    }
}
